<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
        }
        .header h2 {
            margin: 0;
        }
        #delete-data-btn {
            margin-left: auto;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
        }
        .column {
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .left-column {
            flex: 2;
            border-right: 1px solid #ccc;
            display: flex;
            flex-direction: column;
        }
        .right-column {
            flex: 1;
        }
        #chat-form {
            padding: 10px 0;
            display: flex;
        }
        #question {
            flex-grow: 1;
            padding: 5px;
            resize: none; /* Prevents manual resizing */
        }
        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .message {
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 5px;
        }
        .user {
            background-color: #e6f3ff;
            align-self: flex-end;
        }
        .assistant {
            background-color: #f0f0f0;
            align-self: flex-start;
        }
        .token-usage {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }
        #conversation-list {
            list-style-type: none;
            padding: 0;
        }
        #conversation-list li {
            cursor: pointer;
            padding: 5px;
            margin-bottom: 5px;
            background-color: #f0f0f0;
            border-radius: 3px;
        }
        #conversation-list li:hover {
            background-color: #e0e0e0;
        }
        #new-conversation-btn {
            margin-left: 10px;
        }
        .spinner {
            display: none;
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0,0,0,.3);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }
        #logout-btn {
            position: absolute;
            top: 10px;
            right: 10px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <button id="logout-btn" onclick="location.href='/logout'">Logout</button>

    <div class="column left-column">
        <div id="token-usage">Total Tokens Used: 0</div>
        <form id="chat-form">
            <input type="hidden" id="conv-id" name="conv_id" value="">
            <textarea id="question" name="question" rows="3" required placeholder="Enter your question or start a new conversation..."></textarea>
            <button type="submit">Send</button>
            <button type="button" id="new-conversation-btn">New Chat</button>
        </form>
    <div class="spinner" id="loading-spinner"></div>
    <div id="chat-history"></div>
    </div>
    <div class="column right-column">
        <div class="llm_info">
            <p>LLM Model: {{ client_class_name }}'s {{ model_name }} model</p>
        </div>
        <div class="header">
            <h2>Chat History</h2>
            <button id="delete-data-btn">Delete All History</button>
        </div>
        <ul id="conversation-list"></ul>
    </div>

    <script>
        let totalTokens = 0;
        let currentConversationId = null;

        function showSpinner() {
            $('#loading-spinner').show();
        }

        function hideSpinner() {
            $('#loading-spinner').hide();
        }

        window.onload = function() {
            loadConversations();
            startNewConversation(); // Initialize with a new conversation
        };

        function loadConversations() {
            fetch('/get_conversations')
                .then(response => response.json())
                .then(conversations => {
                    const list = document.getElementById('conversation-list');
                    list.innerHTML = '';
                    conversations.forEach(conv => {
                        const li = document.createElement('li');
                        li.textContent = conv.name;

                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.style.marginLeft = '10px';
                        deleteBtn.onclick = (event) => {
                            event.stopPropagation();
                            deleteConversation(conv.id);
                        };

                        li.appendChild(deleteBtn);
                        li.onclick = () => loadConversation(conv.id);
                        list.appendChild(li);
                    });
                });
        }

        function loadConversation(convId) {
            showSpinner();
            currentConversationId = convId;
            $('#conv-id').val(convId);
            $.get(`/get_conversation/${convId}`, function(data) {
                hideSpinner();
                $('#conversation-title').text(data.title);
                const chatHistory = $('#chat-history').empty();

                data.messages.forEach(function(message) {
                    chatHistory.append(createMessageDiv(message));
                });

                updateTotalTokenUsage(data.token_usage.total_tokens, true);
            });
        }

        function createMessageDiv(message) {
            const messageDiv = $('<div></div>')
                .addClass(`message ${message.role}`)
                .attr('data-id', message.id);

            messageDiv.html(`<strong>${message.role.charAt(0).toUpperCase() + message.role.slice(1)}:</strong> ${message.content}`);

            // Add token usage if present
            if (message.token_usage) {
                const tokenUsageDiv = $('<div></div>')
                    .addClass('token-usage')
                    .text(message.token_usage);
                messageDiv.append(tokenUsageDiv);
            }

            // Add a small display of the message ID (for debugging purposes)
            const idDisplay = $('<small></small>')
                .addClass('id-display')
                // .text(`(ID: ${message.id})`)
                .css({
                    'display': 'block',
                    'color': '#999',
                    'font-size': '0.8em'
                });
            messageDiv.append(idDisplay);

            return messageDiv;
        }

        $('#chat-form').submit(function(e) {
            e.preventDefault();
            const question = $('#question').val().trim();
            if (!question) return;

            const convId = $('#conv-id').val();
            showSpinner();

            if (!convId) {
                // Start a new conversation
                $.ajax({
                    url: '/new_conversation',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ initial_question: question }),
                    success: function(data) {
                        hideSpinner();
                        currentConversationId = data.conv_id;
                        $('#conv-id').val(data.conv_id);
                        $('#conversation-title').text(data.title);
                        const chatHistory = $('#chat-history').empty();

                        // Add assistant response
                        chatHistory.append(createMessageDiv({
                            id: data.assistant_message_id,
                            role: 'assistant',
                            content: data.initial_answer,
                            token_usage: `Input ${data.token_usage.prompt_tokens}, Output ${data.token_usage.completion_tokens}, Total ${data.token_usage.total_tokens}`
                        }));

                        // Add user question
                        chatHistory.append(createMessageDiv({
                            id: data.user_message_id,
                            role: 'user',
                            content: question
                        }));

                        updateTotalTokenUsage(data.token_usage.total_tokens);
                        loadConversations();
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        hideSpinner();
                        console.error('Error:', textStatus, errorThrown);
                        alert('An error occurred while starting a new conversation.');
                    }
                });
            } else {
                // Continue existing conversation
                $.ajax({
                    url: '/ask',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ conv_id: convId, question: question }),
                    success: function(data) {
                        hideSpinner();
                        const chatHistory = $('#chat-history');

                        // Add user question
                        chatHistory.prepend(createMessageDiv({
                            id: data.user_message_id,
                            role: 'user',
                            content: question
                        }));

                        // Add assistant response
                        chatHistory.prepend(createMessageDiv({
                            id: data.assistant_message_id,
                            role: 'assistant',
                            content: data.response,
                            token_usage: `Input ${data.token_usage.input_tokens}, Output ${data.token_usage.output_tokens}, Total ${data.token_usage.total_tokens}`
                        }));

                        updateTotalTokenUsage(data.token_usage.total_tokens);
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        hideSpinner();
                        console.error('Error:', textStatus, errorThrown);
                        alert('An error occurred while processing your request.');
                    }
                });
            }
            $('#question').val('');
        });

        function startNewConversation() {
            currentConversationId = null;
            document.getElementById('conv-id').value = '';
            document.getElementById('conversation-title').textContent = '';
            document.getElementById('chat-history').innerHTML = ''; //can add title 'Title HERE' for the app
            document.getElementById('token-usage').textContent = 'Total Tokens Used: 0';
            totalTokens = 0;
        };

        // return enter key submit while use textarea for input box
        document.getElementById('question').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Prevent default to avoid newline
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            }
        });

        // Function to delete all data with confirmation
        document.getElementById('delete-data-btn').onclick = function() {
            if (confirm('Are you sure you want to delete all data? This action cannot be undone.')) {
                showSpinner();
                $.ajax({
                    url: '/delete_all_data',
                    method: 'POST',
                    success: function() {
                        hideSpinner();
                        alert('All data has been deleted.');
                        loadConversations();
                        startNewConversation();
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        hideSpinner();
                        console.error('Error:', textStatus, errorThrown);
                        alert('An error occurred while deleting the data.');
                    }
                });
            }
        };

        // Function to delete one Conversation based on conv_id
        function deleteConversation(convId) {
            if (confirm('Are you sure you want to delete this conversation? This action cannot be undone.')) {
                $.ajax({
                    url: `/delete_conversation/${convId}`,
                    method: 'POST',
                    success: function() {
                        alert('Conversation has been deleted.');
                        loadConversations();
                        startNewConversation();
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        console.error('Error:', textStatus, errorThrown);
                        alert('An error occurred while deleting the conversation.');
                    }
                });
            }
        }

        // New Chat conversation click action
        document.getElementById('new-conversation-btn').onclick = startNewConversation;

        function updateTotalTokenUsage(usage, reset = false) {
            if (reset) {
                totalTokens = usage;
            } else {
                totalTokens += usage;
            }
            document.getElementById('token-usage').textContent = `Total Tokens Used: ${totalTokens}`;
        }
    </script>
</body>
</html>
